function [dx] = pendcart(x,u,i)

% Sx = sin(x(3));
% Cx = cos(x(3));
% D = m*L*L*(M+m*(1-Cx^2));
% 
% dx(1,1) = x(2);
% dx(2,1) = (1/D)*(-m^2*L^2*g*Cx*Sx + m*L^2*(m*L*x(4)^2*Sx - d*x(2))) + m*L*L*(1/D)*u;
% dx(3,1) = x(4);
% dx(4,1) = (1/D)*((m+M)*m*g*L*Sx - m*L*Cx*(m*L*x(4)^2*Sx - d*x(2))) - m*L*Cx*(1/D)*u;
%u = -K*x(1);
theta0 = x(1);
theta1 = x(2);
theta2 = x(3);
theta0_dot = x(4);
theta1_dot = x(5);
theta2_dot = x(6);

T41_1 = (theta1_dot*((3*theta1_dot*sin(theta1 - theta2)*(8*cos(theta2) - 9*cos(theta1 - theta2)*cos(theta1)))/(4*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) + (3*theta1_dot*sin(theta1)*(9*cos(theta1 - theta2)^2 - 16))/(4*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112))) - theta2_dot*((9*theta2_dot*sin(theta1 - theta2)*(2*cos(theta1) - cos(theta1 - theta2)*cos(theta2)))/(4*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) - (theta2_dot*sin(theta2)*(9*cos(theta1 - theta2)^2 - 16))/(4*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)))); %(theta2*((3*theta1_dot*sin(theta1 - theta2)*(8*cos(theta2) - 9*cos(theta1 - theta2)*cos(theta1)))/(4*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) + (3*theta1_dot*sin(theta1)*(9*cos(theta1 - theta2)^2 - 16))/(4*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112))) - theta2_dot*((9*theta2_dot*sin(theta1 - theta2)*(2*cos(theta1) - cos(theta1 - theta2)*cos(theta2)))/(4*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) - (theta2_dot*sin(theta2)*(9*cos(theta1 - theta2)^2 - 16))/(4*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112))));
T41_2 = (66231*sin(theta1)*(2*cos(theta1) - cos(theta1 - theta2)*cos(theta2)))/(500*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) + (7359*sin(theta2)*(8*cos(theta2) - 9*cos(theta1 - theta2)*cos(theta1)))/(500*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112));
T41_3 = ((9*cos(theta1 - theta2)^2 - 16)/(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112));

T51_1 = (theta1_dot*((27*theta1_dot*sin(theta1)*(2*cos(theta1) - cos(theta1 - theta2)*cos(theta2)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) + (9*theta1_dot*sin(theta1 - theta2)*(14*cos(theta1 - theta2) - 3*cos(theta1)*cos(theta2)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112))) + theta2_dot*((9*theta2_dot*sin(theta2)*(2*cos(theta1) - cos(theta1 - theta2)*cos(theta2)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) - (3*theta2_dot*sin(theta1 - theta2)*(3*cos(theta2)^2 - 28))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112))));%theta2*((27*theta1_dot*sin(theta1)*(2*cos(theta1) - cos(theta1 - theta2)*cos(theta2)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) + (9*theta1_dot*sin(theta1 - theta2)*(14*cos(theta1 - theta2) - 3*cos(theta1)*cos(theta2)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112))) + theta2_dot*((9*theta2_dot*sin(theta2)*(2*cos(theta1) - cos(theta1 - theta2)*cos(theta2)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) - (3*theta2_dot*sin(theta1 - theta2)*(3*cos(theta2)^2 - 28))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)));
T51_2 = (22077*sin(theta1)*(3*cos(theta2)^2 - 28))/(250*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) + (22077*sin(theta2)*(14*cos(theta1 - theta2) - 3*cos(theta1)*cos(theta2)))/(250*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112));
T51_3 = ((18*(2*cos(theta1) - cos(theta1 - theta2)*cos(theta2)))/(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112));

T61_1 = (theta2_dot*((3*theta2_dot*sin(theta2)*(8*cos(theta2) - 9*cos(theta1 - theta2)*cos(theta1)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) - (9*theta2_dot*sin(theta1 - theta2)*(14*cos(theta1 - theta2) - 3*cos(theta1)*cos(theta2)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112))) + theta1_dot*((9*theta1_dot*sin(theta1)*(8*cos(theta2) - 9*cos(theta1 - theta2)*cos(theta1)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) + (3*theta1_dot*sin(theta1 - theta2)*(27*cos(theta1)^2 - 112))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112))));%(theta2_dot*((3*theta2_dot*sin(theta2)*(8*cos(theta2) - 9*cos(theta1 - theta2)*cos(theta1)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) - (9*theta2_dot*sin(theta1 - theta2)*(14*cos(theta1 - theta2) - 3*cos(theta1)*cos(theta2)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112))) + theta2*((9*theta1_dot*sin(theta1)*(8*cos(theta2) - 9*cos(theta1 - theta2)*cos(theta1)))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) + (3*theta1_dot*sin(theta1 - theta2)*(27*cos(theta1)^2 - 112))/(2*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112))));
T61_2 = ((7359*sin(theta2)*(27*cos(theta1)^2 - 112))/(250*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)) + (66231*sin(theta1)*(14*cos(theta1 - theta2) - 3*cos(theta1)*cos(theta2)))/(250*(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112)));
T61_3 = ((6*(8*cos(theta2) - 9*cos(theta1 - theta2)*cos(theta1)))/(27*cos(theta1)^2 + 12*cos(theta2)^2 + 63*cos(theta1 - theta2)^2 - 27*cos(theta1 - theta2)*cos(theta1)*cos(theta2) - 112));


dx(1,1) = theta0_dot;
dx(2,1) = theta1_dot;
dx(3,1) = theta2_dot;   
dx(4,1) = T41_1 + T41_2 + T41_3*u;
dx(5,1) = T51_1 + T51_2 + T51_3*u;
dx(6,1) = T61_1 + T61_2 + T61_3*u;

%ACCL_C(i,1) = dx(4,1);

dx = [dx(1,1),dx(2,1),dx(3,1),dx(4,1),dx(5,1),dx(6,1)]';

%dx(4,1) = (theta2_dot*((theta2_dot*sin(theta1 - theta2)*(cos(theta1)/16 - (cos(theta1 - theta2)*cos(theta2))/32))/(8*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)) - (theta2_dot*sin(theta2)*(cos(theta1 - theta2)^2/64 - 1/36))/(4*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36))) - theta2*((theta1_dot*sin(theta1 - theta2)*(cos(theta2)/12 - (3*cos(theta1 - theta2)*cos(theta1))/32))/(8*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)) + (3*theta1_dot*sin(theta1)*(cos(theta1 - theta2)^2/64 - 1/36))/(4*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36))) - (cos(theta1 - theta2)^2/64 - 1/36)/(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36) - (2453*sin(theta2)*(cos(theta2)/12 - (3*cos(theta1 - theta2)*cos(theta1))/32))/(1000*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)) - (7359*sin(theta1)*(cos(theta1)/16 - (cos(theta1 - theta2)*cos(theta2))/32))/(1000*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)))*u;
%dx(5,1) = (-theta2_dot*((theta2_dot*sin(theta2)*(cos(theta2)/16 - (cos(theta1 - theta2)*cos(theta2))/32))/(4*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)) - (theta2_dot*sin(theta1 - theta2)*(cos(theta2)^2/16 - 7/12))/(8*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36))) - theta2*((theta1_dot*sin(theta1 - theta2)*((7*cos(theta1 - theta2))/8 - (3*cos(theta2)^2)/16))/(8*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)) + (3*theta1_dot*sin(theta1)*(cos(theta2)/16 - (cos(theta1 - theta2)*cos(theta2))/32))/(4*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36))) - (cos(theta2)/16 - (cos(theta1 - theta2)*cos(theta2))/32)/(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36) - (7359*sin(theta1)*(cos(theta2)^2/16 - 7/12))/(1000*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)) - (2453*sin(theta2)*((7*cos(theta1 - theta2))/8 - (3*cos(theta2)^2)/16))/(1000*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)))*u;
end
%dx(6,1) = (-theta2_dot*((theta2_dot*sin(theta2)*(cos(theta2)/12 - (3*cos(theta1 - theta2)*cos(theta2))/32))/(4*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)) - (theta2_dot*sin(theta1 - theta2)*((7*cos(theta1 - theta2))/8 - (3*cos(theta1)*cos(theta2))/16))/(8*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36))) - theta2*((theta1_dot*sin(theta1 - theta2)*((9*cos(theta1)*cos(theta2))/16 - 7/3))/(8*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)) + (3*theta1_dot*sin(theta1)*(cos(theta2)/12 - (3*cos(theta1 - theta2)*cos(theta2))/32))/(4*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36))) - (cos(theta2)/12 - (3*cos(theta1 - theta2)*cos(theta2))/32)/(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36) - (2453*sin(theta2)*((9*cos(theta1)*cos(theta2))/16 - 7/3))/(1000*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)) - (7359*sin(theta1)*((7*cos(theta1 - theta2))/8 - (3*cos(theta1)*cos(theta2))/16))/(1000*(cos(theta2)^2*((3*cos(theta1 - theta2))/128 - 1/48) - (7*cos(theta1 - theta2)^2)/64 + cos(theta1)*cos(theta2)*((3*cos(theta1 - theta2))/128 - 3/64) + 7/36)))*u;